\newpage{}

# Introduction

R [@R] has the ability to display mathematical symbols and equations in graphics using the "plotmath" feature [@plotmath], interpreting everything within a call to `expression()` as a mathematical equation.

<!--- 

Need to think of a better example than this one, ideally one that brings in our x - mu somehow 

Redo this plot with lattice?

CHECK - that I haven't confused axis labela and axis titles... should be axis titles!
--->

```{r expressionPlot, fig.cap="A plot with axis labels made using \\texttt{expression()}.", include = TRUE, eval = TRUE}
x <- 1:5
opar <- par(mar = par()$mar + c(0, 1, 0, 0))
plot(x, x ^ 2 / 2, xlab = expression(mu), ylab = "", yaxt = "n")
axis(2, las = 1)
mtext(expression(frac(mu ^ 2, 2)), side = 2, line = 3, las = 1)
```

This provides us with most of the symbols used for equations, such as brackets and fractions, and formats them in a layout resembling \TeX{} [@knuth-tex], but it is limited in its fonts. Compare the y-axis label above with how it looks when created by \LaTeX{} in figure \ref{muOver2}.

\begin{figure}\label{muOver2}
\begin{equation*}
\dfrac{\mu^2}{2}
\end{equation*}
\caption{The \(y\)-axis label from above, when created in \LaTeX}
\end{figure}

<!---
Use this code for above example, just need to find a way to caption and reference it. Also delete image from figures folder when done



could use \[\dfrac{\mu^2}{2}\] if that was easier too?
--->

The difference is stark and @murrell-dvir describes several approaches in R which can get us closer to the \LaTeX{} result, and their limitations, as motivation for the `dvir` package. The approaches are replicated here.

[@pkg-extrafont]
[@pkg-fontcm]
```{r}
# library(grid)
# expr <- expression(frac(mu ^ 2, 2 "hello"))
# grid.text(expr)
# 
# library(extrafont)
# font_install('fontcm')
# loadfonts("pdf")
# pdf("extrafont2.pdf", width=1, height=1)
# grid.text(expr,
#           gp = gpar(fontfamily="CM Roman"))
# dev.off()
# embed_fonts("extrafont2.pdf", outfile="extrafont2-embed.pdf")

```

<!---

Do plot with type = "l"?
--->


<!--- 
for these examples following, say that Paul's report descirbes the limitations of these approaches, and replicate the examples



FOR THIS, SAY IT WORKS FOR OUR LABEL, BUT DOESN"T WITH OTHER THINGS, LIKE THE BRACKETS
--->
  - [**Example:** use `extrafont` and `fontcm` packages, embed CM fonts in PDF - say it works for our case, but not if you havem say, brackets]

```{r results = FALSE}
# Using the 'tikzDevice' package
library(tikzDevice)
options(tikzDocumentDeclaration = "\\documentclass[12pt]{article}")
packages <- c(getOption("tikzLatexPackages"),
              "\\usepackage{amsmath}\n")
options("tikzLatexPackages" = packages) 

tikz("tikzDevice.tex", standAlone = TRUE)
opar <- par(mar = par()$mar + c(0, 1, 0, 0))
plot(x, x ^ 2 / 2, xlab = "$\\mu$", ylab = "", yaxt = "n")
axis(2, las = 1)
mtext("$\\dfrac{\\mu^2}{2}$", side = 2, line = 3, las = 1)
dev.off()
```

<!---
Try get scaling a bit better in this tikz one, to better match the original plot? Or make the earlier one square! (this is probably easier)

Try make the plots all same size (like same sqize square) too!
--->

```{r echo = FALSE, results = "asis"}
tikzTex <- readLines("tikzDevice.tex")
start <- which(grepl("begin\\{document}", tikzTex))
end <- which(grepl("end\\{document}", tikzTex))

beginTikzPic <- which(grepl("begin\\{tikzpicture}", tikzTex))
tikzTex[beginTikzPic] <- gsub("]", ",scale=0.5]", tikzTex[beginTikzPic])
cat(c("\\begin{figure}\\label{tikzDevicePlot}\n\\centering\n", 
      paste0(tikzTex[(start + 1):(end - 1)], 
             collapse = "\n"),
      "\\caption{Drawing the plot with the \\texttt{tikzDevice} package}\n",
      "\\end{figure}"))
```

The `tikzDevice` package in R will draw the axis titles with \TeX{} but will also use \TeX{} for all other text on the plot, like the axis labels in figure \ref{tikzDevicePlot}. This may be appropriate if the graphic is to be included in a \TeX{} document but not so much for other document formats like HTML.

What we want is a middle ground - being able to harness the power of \TeX{} and its typesetting capabilities on *our* choice of text or equation in R graphics. This is where the `dvir` package comes in - providing a simple user interface, in the style of R `grid` graphics, by way of the `grid.latex()` function.

<!---
For lattice plot, remember tick marks on top and side.... remove if have time....

For lattice plot, need to see if can correctly find x and y locations relative to other stuff in the plot, rather than guessing and checking these exact values, at least navigate to other viewports? (try grid.force() maybe, and make a coloured rectangle in each one)


DO I NEED TO USE LATTIVE F THIS?
--->
```{r, include = FALSE}
# Set lattice options for next plot
lattice::lattice.options(layout.heights=list(bottom.padding=list(x=1.5)),
                         layout.widths=list(left.padding=list(x=1.5)))
```

```{r latticeGridLatex, fig.cap = "Changing axis titles with \\texttt{grid.latex()}", }
y <- x ^ 2 / 2
preamble <- "\\documentclass[12pt]{standalone}\n\\usepackage{amsmath}\n\\begin{document}"
lattice::xyplot(y ~ x, xlab = "", ylab = "", aspect = 1, col = "black")
grid.latex("$\\mu$", x = 0.53, y = 0.03)
grid.latex("$\\dfrac{\\mu^2}{2}$", x = 0.1, preamble = preamble)
```

Figure \@ref(fig:latticeGridLatex) recreates figure \@ref(fig:expressionPlot) with the axis titles made using `grid.latex()`. The function `lattice::xyplot()` [@pkg-lattice] is used as it is a readily available high-level plotting function using `grid` graphics.

<!---
  - [**Example:** example of grid-based plot, changing labels and/or title with `grid.latex()`. Maybe ggplot2?]
  
  Nah - got the lattice plot of our example....
  --->

## Where this project fits in

The `dvir` package already worked really well in a lot of cases. There were however a number of desirable features of \TeX{} and its extensions that had not yet been implemented by `dvir`. The power of this package comes from ensuring it is comprehensive enough to meet a user's entire \TeX{} needs in R graphics without having to leave R to do annotations in \LaTeX{} itself (or other software like Adobe Photoshop or Illustrator). 

By keeping things "in R" users only need to learn R (and basic \TeX) code to create their graphics and their work is in one place and easily reproducible. It may not be realistic to *completely* replicate \TeX{} in R, however several aspects of the package were identified as having the potential to increase its usefulness. The aspects identified were:

* the speed of the package - anecdotally it took a while to generate graphics, especially if there were many `grid.latex()` calls
* expand `dvir`'s capability of creating \Tikz{} drawings by adding support for linear gradient fills
* adding the ability to align text from `grid.latex()` to a baseline - the natural line on which characters sit